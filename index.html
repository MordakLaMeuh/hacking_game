<!DOCTYPE html>
<html>
<head>
	<title>Mini Chat-Box</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="hacking_game">
	<meta name="author" content="team_banane">
	<link rel="shortcut icon" href="medias/ours.png">
	<style type="text/css">
		*	{
			padding: 0px;
			margin: 0px;
		}
		body 	{
			display: block;
			background:#000000;
    		height:100vh;
    		width: 100vw;
    		position: fixed;
		}
		#js_tty {
			height:100vh;
			width: 100vw;
			color: #00FF00;
			font-family: monospace;
			overflow:hidden;
			font-size: 20px;
		}

	</style>
<!--  <link rel='stylesheet' href='modulableWindow.css' type='text/css' media='all'> -->

</head>

<body>

<div id="js_tty">

</div>


<script type="text/javascript">

/*
	window.ondragstart = function()		{ return false; }	// IMPORTANT - FIX BUG
	document.onmousedown = function()	{ return false; }	// IMPORTANT - FIX BUG / DISABLE AUTOMATIC SELECT OF ELEMENT
*/

var mousewheelevt=(/Firefox/i.test(navigator.userAgent)) ? "DOMMouseScroll" : "mousewheel"

var socket  = new WebSocket('ws://localhost:8081');
var tty = document.getElementById("js_tty");
tty.innerHTML = "";

tty.addEventListener(mousewheelevt, function(e) {
	var e = window.event || e; // old IE support
	var delta = Math.max(-1, Math.min(1, (e.wheelDelta || -e.detail)));
	tty.scrollTop -= delta * 20;
}, false);

const space_expr = "&nbsp;";
const space_regex = /&nbsp;/g;

var inputHistory = new Array();
var historyIdx;

var inputString;
var cursorPosition;
var systemInputMsg = "banane@hacking_game:" + space_expr;

var createNewInputString = function(optionalStr)
{
	inputString = systemInputMsg;
	if (optionalStr)
		inputString += optionalStr;
	cursorPosition = inputString.length;
	inputDiv = document.createElement('div');
	inputDiv.innerHTML = inputString;
	tty.appendChild(inputDiv);

	tty.scrollTop += 10000;
}

var createDiv = function(content)
{
	outputDiv = document.createElement('div');
	outputDiv.innerHTML = content;
	tty.appendChild(outputDiv);

	tty.scrollTop += 10000;
}

var refreshInput = function(inputDiv)
{
	tty.removeChild(inputDiv);
	inputDiv.innerHTML = inputString;
	tty.appendChild(inputDiv);

	tty.scrollTop += 10000;
}

function removeCharacters(str, char_pos, len)
{
	part1 = str.substring(0, char_pos);
	part2 = str.substring(char_pos + len, str.length);
	return part1 + part2;
}

socket.onerror = function()
{
	createDiv("Aucune rÃ©ponse du serveur..");

	historyIdx = inputHistory.length;
	createNewInputString();
}

socket.onmessage = function(res)
{
	data = JSON.parse(res.data);

	createDiv(data.result);

	historyIdx = inputHistory.length;
	createNewInputString();
};

historyIdx = inputHistory.length;
createNewInputString();

document.addEventListener('keypress', (event) => {
	key = event.key;

	if (key.length == 1) {
		part1 = inputString.substring(0, cursorPosition);
		console.log("part_1: '" + part1 + "'");

		part2 = inputString.substring(cursorPosition, inputString.length);
		console.log("part_2: '" + part2 + "'");

		if (key == " ") {
			key = space_expr;
			cursorPosition += space_expr.length;
		} else {
			cursorPosition += 1;
		}
		inputString = part1 + key + part2;

		refreshInput(inputDiv);

		historyIdx = inputHistory.length;
	}

	switch(key) {
	case "Backspace":
		if (cursorPosition != systemInputMsg.length) {
			var idx = inputString.substring(0, cursorPosition).lastIndexOf(space_expr);
			var len;
			if (cursorPosition - idx == space_expr.length)
				len = space_expr.length;
			else
				len = 1;
			cursorPosition -= len;
			inputString = removeCharacters(inputString, cursorPosition, len);

			historyIdx = inputHistory.length;
		}
		refreshInput(inputDiv);
		break;
	case "Enter":
		var outStr = inputString.slice(systemInputMsg.length);
		var outStrPostProcessed = outStr.replace(space_regex, " ");

		if (outStrPostProcessed.trim().length == 0) {
			historyIdx = inputHistory.length;
			createNewInputString();
			break;
		}

		if (inputHistory.length == 0 ||
				inputHistory[inputHistory.length - 1] != outStr)
			inputHistory.push(outStr);

		socket.send(JSON.stringify({"command":outStrPostProcessed}));
		break;
	case "ArrowRight":
		if (cursorPosition < inputString.length) {
			var idx = inputString.substring(cursorPosition, inputString.length).indexOf(space_expr);
			if (idx == 0)
				cursorPosition += space_expr.length;
			else
				cursorPosition += 1;

			historyIdx = inputHistory.length;
		}
		break;
	case "ArrowLeft":
		if (cursorPosition != systemInputMsg.length) {
			var idx = inputString.substring(0, cursorPosition).lastIndexOf(space_expr);
			if (cursorPosition - idx == space_expr.length)
				cursorPosition -= space_expr.length;
			else
				cursorPosition -= 1;

			historyIdx = inputHistory.length;
		}
		break;
	case "ArrowUp":
		if (historyIdx != 0) {
			tty.removeChild(inputDiv);
			historyIdx -= 1;
			createNewInputString(inputHistory[historyIdx]);

			console.log("new history index: ", historyIdx);
		}

		break;
	case "ArrowDown":
		if (historyIdx != inputHistory.length) {
			tty.removeChild(inputDiv);
			historyIdx += 1;
			createNewInputString(inputHistory[historyIdx]);

			console.log("new history index: ", historyIdx);
		}
		break;
	default:
		break;
	}

	console.log("key: " + key + " position: " + cursorPosition);
});

</script>
</body>
</html>
