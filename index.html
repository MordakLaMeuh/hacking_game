<!DOCTYPE html>
<html>
<head>
	<title>Mini Chat-Box</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="hacking_game">
	<meta name="author" content="team_banane">
	<link rel="shortcut icon" href="medias/ours.png">
	<style type="text/css">
		*	{
			padding: 0px;
			margin: 0px;
		}
		body 	{
			display: block;
			background:#FFFFFF;
    		height:100vh;
    		width: 100vw;
    		position: fixed;
		}
		#js_tty {
			height:100vh;
			width: 1200px;
			color: #00FF00;
			background:#000000;
			font-family: monospace;
			overflow:hidden;
			font-size: 20px;
			word-wrap:break-word;
		}
		#cursor {
			height: 24px;
			width: 12px;
			background: #00FF00;
			opacity: 0.6;
			position: absolute;
		}

	</style>
<!--  <link rel='stylesheet' href='modulableWindow.css' type='text/css' media='all'> -->

</head>

<body>

<div id="js_tty">

<!-- <span id="test">a</span> -->

</div>


<script type="text/javascript">

/*
	window.ondragstart = function()		{ return false; }	// IMPORTANT - FIX BUG
	document.onmousedown = function()	{ return false; }	// IMPORTANT - FIX BUG / DISABLE AUTOMATIC SELECT OF ELEMENT
*/

var mousewheelevt=(/Firefox/i.test(navigator.userAgent)) ? "DOMMouseScroll" : "mousewheel"

var socket  = new WebSocket('ws://localhost:8081');
var tty = document.getElementById("js_tty");
tty.innerHTML = "";

tty.addEventListener(mousewheelevt, function(e) {
	var e = window.event || e; // old IE support
	var delta = Math.max(-1, Math.min(1, (e.wheelDelta || -e.detail)));
	tty.scrollTop -= delta * 20;
}, false);

const space_expr = "&nbsp;";
const space_regex = /&nbsp;/g;

var inputHistory = new Array();
var historyIdx;

var inputString;
var inputDiv;
var cursorPosition;
var systemInputMsg;

/*
 * visible len and cursor position, avoid exeption of &nbsp;
 */
var visibleCursorPosition;

var putCursor = function(position)
{
	var div_origin_y = inputDiv.getBoundingClientRect().top;
	var div_origin_x = inputDiv.offsetLeft;
	var div_width = inputDiv.offsetWidth;

	var x_pixel = position % (div_width / 12) * 12;
	var y_pixel = Math.trunc(position / (div_width / 12)) * 24;

	cursor.style.left = div_origin_x + x_pixel + "px";
	cursor.style.top = div_origin_y + y_pixel + "px";

	console.log("new visible cur position: " + position);
}

var createNewInputString = function(prompt, optionalStr)
{
	systemInputMsg = prompt;
	inputString = systemInputMsg;
	if (optionalStr)
		inputString += optionalStr;
	cursorPosition = inputString.length;
	inputDiv = document.createElement('div');
	inputDiv.innerHTML = inputString;
	tty.appendChild(inputDiv);

	visibleCursorPosition = inputString.replace(space_regex, " ").length;

	tty.scrollTop += 10000;
	putCursor(visibleCursorPosition);
}

var createDiv = function(content)
{
	outputDiv = document.createElement('div');
	outputDiv.innerHTML = content;
	tty.appendChild(outputDiv);

	tty.scrollTop += 10000;
}

var refreshInput = function(inputDiv)
{
	tty.removeChild(inputDiv);
	inputDiv.innerHTML = inputString;
	tty.appendChild(inputDiv);

	tty.scrollTop += 10000;
}

function removeCharacters(str, char_pos, len)
{
	part1 = str.substring(0, char_pos);
	part2 = str.substring(char_pos + len, str.length);
	return part1 + part2;
}

document.addEventListener('keydown', (event) => {
	key = event.key;

	/*
	 * Prevent the quick search feature on Firefox triggered by /
	 */
	if (key == "/") {
		event.stopPropagation();
		event.preventDefault();
	}

	if (key.length == 1) {
		part1 = inputString.substring(0, cursorPosition);
		console.log("part_1: '" + part1 + "'");

		part2 = inputString.substring(cursorPosition, inputString.length);
		console.log("part_2: '" + part2 + "'");

		if (key == " ") {
			key = space_expr;
			cursorPosition += space_expr.length;
		} else {
			cursorPosition += 1;
		}
		visibleCursorPosition += 1;

		inputString = part1 + key + part2;

		refreshInput(inputDiv);
		putCursor(visibleCursorPosition);

		historyIdx = inputHistory.length;
	}

	switch(key) {
	case "Backspace":
		if (cursorPosition != systemInputMsg.length) {
			var idx = inputString.substring(0, cursorPosition).lastIndexOf(space_expr);
			var len;
			if (cursorPosition - idx == space_expr.length)
				len = space_expr.length;
			else
				len = 1;
			cursorPosition -= len;

			visibleCursorPosition -= 1;

			inputString = removeCharacters(inputString, cursorPosition, len);
			putCursor(visibleCursorPosition);

			historyIdx = inputHistory.length;
		}
		refreshInput(inputDiv);
		break;
	case "Enter":
		process(inputString.slice(systemInputMsg.length));
		break;
	case "ArrowRight":
		if (cursorPosition < inputString.length) {
			var idx = inputString.substring(cursorPosition, inputString.length).indexOf(space_expr);
			if (idx == 0)
				cursorPosition += space_expr.length;
			else
				cursorPosition += 1;

			visibleCursorPosition += 1;
			putCursor(visibleCursorPosition);

			historyIdx = inputHistory.length;
		}
		break;
	case "ArrowLeft":
		if (cursorPosition != systemInputMsg.length) {
			var idx = inputString.substring(0, cursorPosition).lastIndexOf(space_expr);
			if (cursorPosition - idx == space_expr.length)
				cursorPosition -= space_expr.length;
			else
				cursorPosition -= 1;

			visibleCursorPosition -= 1;
			putCursor(visibleCursorPosition);

			historyIdx = inputHistory.length;
		}
		break;
	case "ArrowUp":
		if (historyIdx != 0) {
			tty.removeChild(inputDiv);
			historyIdx -= 1;
			createNewInputString(login + "@" + server_name + ":" + space_expr, inputHistory[historyIdx]);

			console.log("new history index: ", historyIdx);
		}

		break;
	case "ArrowDown":
		if (historyIdx != inputHistory.length) {
			tty.removeChild(inputDiv);
			historyIdx += 1;
			createNewInputString(login + "@" + server_name + ":" + space_expr, inputHistory[historyIdx]);

			console.log("new history index: ", historyIdx);
		}
		break;
	default:
		break;
	}

	console.log("key: " + key + " position: " + cursorPosition);
});

socket.onerror = function()
{
	createDiv("Aucune rÃ©ponse du serveur..");

	historyIdx = inputHistory.length;
	createNewInputString("error");
}

const sequence_enum = {
	"auth_login": 0,
	"auth_password": 1,
	"running": 2,
}
var sequence = sequence_enum.auth_login;

socket.onmessage = function(res)
{
	data = JSON.parse(res.data);

	switch (sequence) {
	case sequence_enum.auth_password:
		if (data.auth == 1) {
			sequence = sequence_enum.running;
			createDiv("<br>");
			createDiv("Welcome to " + server_name + " Mr " + login);
			createDiv("<br>");
			createNewInputString(login + "@" + server_name + ":" + space_expr);
		} else {
			sequence = sequence_enum.auth_login;
			createDiv("<br>");
			createNewInputString(server_name + space_expr + "login:" + space_expr);
		}
		break;
	case sequence_enum.running:
		createDiv(data.string);

		historyIdx = inputHistory.length;
		createNewInputString(login + "@" + server_name + ":" + space_expr);
		break;
	default:
		console.warn("Unknown sequence");
		break;
	}
};

var login;
var server_name = "hacking_game";

var process = function(outStr)
{
	var outStrPostProcessed = outStr.replace(space_regex, " ");

	switch (sequence) {
	case sequence_enum.auth_login:
		login = outStrPostProcessed;
		sequence = sequence_enum.auth_password;
		createNewInputString("Password:" + space_expr);
		break;
	case sequence_enum.auth_password:
		socket.send(JSON.stringify({"login":login, "password":outStrPostProcessed}));
		break;
	case sequence_enum.running:
		if (outStrPostProcessed.trim().length == 0) {
			historyIdx = inputHistory.length;
			createNewInputString(systemInputMsg);
			return ;
		}

		if (inputHistory.length == 0 ||
				inputHistory[inputHistory.length - 1] != outStr)
			inputHistory.push(outStr);

		socket.send(JSON.stringify({"command":outStrPostProcessed}));
		break;
	default:
		console.warn("Unknown sequence");
		break;
	}
}

createDiv("Enter login root and password root<br><br>");

/*
 * Calculate from font-size 20px.
 * DIV width must be multiple of 12
 */
cursor = document.createElement('canvas');
cursor.id = "cursor"

historyIdx = 0;
createNewInputString(server_name + "&nbsp;login:" + space_expr);

cursor.getContext('2d');
document.body.appendChild(cursor);

</script>
</body>
</html>
